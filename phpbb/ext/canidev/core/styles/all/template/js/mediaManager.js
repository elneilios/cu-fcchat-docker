/**
 * @package cBB Core
 * @version 1.1.10 24/02/2025
 *
 * @copyright (c) 2025 CaniDev
 * @license https://creativecommons.org/licenses/by-nc/4.0/
 */
((c,d)=>{var t={allowGallery:!0,baseUrl:"",requestData:{},custom:!1,allowImageInfo:!0,imageMaxHeight:0,imageMaxWidth:0,instanceID:"",type:"image",returnMask:"simple",sources:[],beforeLoad:!1,onSubmit:!1},u={items:{},index:[]},h={},a={};cbbCore.registerService("mediaManager",{options:{},_modal:null,__construct:function(){this.bindSelectors()},bindSelectors:function(){var s=this;c('[data-module="media"]').each(function(){var e=c(this).attr("data-value"),t=c(this).attr("data-type"),i=c(this).attr("data-id"),a={delete_class:e?"":"cbb-helper-hidden",delete_label:c(this).attr("data-label-delete"),btn_label:c(this).attr("data-label-btn"),key:c(this).attr("data-key"),value:e,value_parsed:c(this).attr("data-value-parsed")},n=(a.keyFiltered=a.key.replace(/config\[(.*?)\]/,"$1"),c(d.template.parse('<div><div class="cbb-icon-container js-container cbb-helper-hidden"></div><a class="cbb-btn <%delete_class%>" data-action="delete" href="#"><%delete_label%></a><a class="cbb-btn" data-action="manage" href="#"><%btn_label%></a><input type="hidden" name="<%key%>" data-media-param="code" value="<%value%>" /><input type="hidden" name="<%keyFiltered%>_media_id" data-media-param="id" value="" /><input type="hidden" name="<%keyFiltered%>_media_url" data-media-param="url" value="<%value_parsed%>" /></div>',a)));e&&(e=s.isIcon(e)?'<i class="fa '+e+' fa-lg"></i>':'<img src="'+a.value_parsed+'" alt="">',n.children(".js-container").removeClass("cbb-helper-hidden").append(e)),c(this).replaceWith(n),n.children("a[data-action]").click(function(e){e.preventDefault();var a=c(this);switch(a.data("action")){case"delete":a.objView(!1).prev(".js-container").objView(!1).siblings("input[type=hidden]").val(""),d.dispatchEvent("core.media.delete",{instanceID:i});break;case"manage":s.init({baseUrl:"",type:t,instanceID:i,context:n,onSubmit:function(e){var t=a.siblings(".js-container"),i="";a.siblings("[data-media-param]").val(e[0].code).filter("[data-media-param='id']").val(e[0].originalId),a.siblings('[data-media-param="url"]').val(""),s.isIcon(e[0])?i='<i class="fa '+e[0].code+' fa-lg"></i>':(i='<img src=" '+e[0].filename+'" alt="">',a.siblings('[data-media-param="url"]').val(e[0].url)),t.html(i).objView(!0),a.prev('a[data-action="delete"]').objView(!0)}})}})})},init:function(e){this.options=c.extend({},t,e),"function"==typeof this.options.beforeLoad&&this.options.beforeLoad.apply(c,[e]),"icon"==this.options.type&&(this.options.returnMask="simple"),this.options.baseUrl||(this.options.baseUrl=window.location.href),this._send({action:"create",allow_gallery:d.intval(this.options.allowGallery),custom:this.options.custom?1:0,sources:this.options.sources})},getAttributes:function(e){var t={};return c.each(e.get(0).attributes,function(){if("href"==this.name&&(t.baseUrl=this.value),0==this.name.indexOf("data-media")){var e=this.name.replace("data-media-","");switch(this.value){case"true":t[e]=!0;break;case"false":t[e]=!1;break;default:t[e]=c.isNumeric(this.value)?d.intval(this.value):this.value}}}),t},getActivePanel:function(){return void 0!==h.active?h[h.active]:[]},getObj:function(e){return this._modal.find(e)},isIcon:function(e){return"object"==typeof e?"icon"===e.type||"fa-"==e.code.substring(0,3):"fa-"==e.substring(0,3)},rebuildSection:function(i){var e,a,n=[];if(!h[i])return!1;c.each(h[i].items,function(e,t){"object"==typeof t&&n.push(t)}),h[i].sortKeys&&(e=c.extend([],h[i].sortKeys),a={},h[i].sortKeys=[],c.each(n,function(e,t){a[t.id]=e}),c.each(e,function(e,t){null!=a[t]&&h[i].sortKeys.push(a[t])})),h[i].items=c.extend([],n)},removeSelected:function(){let i=this;c.each(u.items,function(e,t){t.remove(),i.options.context&&i.options.context.find('[data-media-param="code"]').val()==h[h.active].items[e].originalId&&i.options.context.find('[data-action="delete"]').click(),delete h[h.active].items[e]}),this.rebuildSection(h.active),i.reset(!0),i._updateSubmitStatus(),this.getObj(".media-toolbar-secondary").objView(!1).find(".value").text(0),this.setActivePanel(h.active)},reset:function(e){u={items:{},index:[]},!0!==e&&(h={},this.options=t)},resetQueue:function(){a={data:null,FileList:[],current:-1,totalBytes:0,bytesLoaded:0,result:[],error:[],statusDom:c([])},this.getObj('.cbb-browser-button input[type="file"]').val(null)},setActivePanel:function(i,e,t){var a,n,s=this,o=0;if(void 0!==i&&void 0!==h[i]){switch(void 0!==h.active&&(this.unselectAll(),this._currentImageInfo(),h[h.active].launcher.removeClass("active")),h.active=i,h[i].launcher.addClass("active"),this.getObj(".cbb-dialog-header h1").text(h[i].launcher.text()),h[i].id){case"upload":s.getObj(".js-section-content").html(s._getTemplate("section-upload")),s.getObj(".cbb-browser-button button").click(function(){c(this).next("input").click()}),s.getObj('.cbb-browser-button input[type="file"]').attr("accept","."+s.options.allowedExtensions.join(",.")).change(function(e){s._handleUpload(e),e.preventDefault()}),this.resetQueue(),s.getObj(".upload-ui").on("drag dragstart dragend dragover dragenter dragleave drop",function(e){e.preventDefault(),e.stopPropagation()}).on({dragenter:function(e){o++,c(this).addClass("is-dragover"),e.preventDefault()},"dragleave dragend":function(){0==--o&&c(this).removeClass("is-dragover")},drop:function(e){o=0,c(this).removeClass("is-dragover"),s._handleUpload(e)}});break;case"insert":var l=null,r=new RegExp(/(http(s)?:\/\/)?(www\.)?[-a-zA-Z0-9\._\+]{2,256}\.[a-z]{2,6}\/(.*)/g);s.getObj(".js-section-content").html(s._getTemplate("section-insert")),s.getObj(".embed-url input").on("input",function(){var e=c(this).val();clearTimeout(l),s.getObj(".spinner, .media-embed-submit").objView(!1),s.getObj(".cbb-dialog-sidebar").html(""),e.match(r)&&(l=setTimeout(function(){s.getObj(".spinner").objView(!0),c("<img />").on({load:function(){if(s.getObj(".spinner").objView(!1),!this.complete||void 0===this.naturalWidth||0==this.naturalWidth)return!1;h[h.active].items=[{id:0,code:e,title:s._getBaseName(e),filename:e,filesize:"",url:e,width:this.naturalWidth,height:this.naturalHeight,type:"attachment"}],u.index=[0],s._currentImageInfo(!1),s.getObj(".media-embed-submit").objView(!0)},error:function(){s.getObj(".spinner").objView(!1)}}).attr("src",e)},1e3))}),s.getObj(".media-embed-submit").find("button").click(function(e){e.preventDefault();e=s.getObj('input[name="copy"]').prop("checked");(s.options.allowRemoteOrigin||e)&&(s._updateSettings(),s._send(c.extend({},h[h.active].items[0],{action:"insert",copy:e?1:0})))}),s.options.allowRemoteOrigin||s.getObj('input[name="copy"]').change(function(){c(this).prop("checked",!0)}).change();break;default:if(e&&(h[i].query||h[i].start))return h[i].query=null,h[i].start=0,a={action:"pagination",section:h[i].id,query:h[i].query,start:0},this._send(a,null,function(){"function"==typeof t&&t.call(s,!0)});s.getObj(".js-section-content").html('<ul class="cbb-media-attachments"></ul>'),h[i].sortKeys?c.each(h[i].sortKeys,function(e,t){h[i].items[t].id=t+0;t=s._getTemplate(s.isIcon(h[i].items[t])?"icon-row":"attachment-row",h[i].items[t]);s.getObj(".cbb-media-attachments").append(t)}):c.each(h[i].items,function(e,t){t.id=e+0;e=s._getTemplate(s.isIcon(t)?"icon-row":"attachment-row",t);s.getObj(".cbb-media-attachments").append(e)}),this.options.allowPagination&&"custom"!=i&&(a=this._getTemplate("seeker-bar"),n=this._buildPagination(h[i]),a.children(".media-pagination").html(n),h[i].query&&a.find('[name="keywords"]').val(h[i].query),a.find('[name="keywords"]').on("keypress",function(e){13==e.which&&s.getObj('[data-action="search"]').click()}),a.find("[data-action]").click(function(e){s._dispatch(c(this),e)}),s.getObj(".js-section-content").addClass("has-seekerbar").prepend(a)),h[i].items.length||s.getObj(".cbb-media-attachments").append(s._getTemplate("attachment-none")),s.getObj(".cbb-media-attachments > li").click(function(e){var t=c(this).is(".selected");s._select(c(this),!t,e)}),h[i].sortable&&s.getObj(".cbb-media-attachments").sortable({cancel:".cbb-message",update:function(){h[h.active].sortKeys=[],s.getObj(".cbb-media-attachments li").each(function(){h[h.active].sortKeys.push(d.intval(c(this).attr("data-id")))})}}).disableSelection()}"function"==typeof t&&t.call(s,!1)}},setSelection:function(e){var i=this;c.each(e,function(e,t){i.getObj('.cbb-media-attachments > li[data-id="'+t+'"]').click()})},unselectAll:function(){var i=this;c.each(u.items,function(e,t){i._select(t,!1)}),this.reset(!0)},_buildPagination:function(e){var t="",i=(e.start=e.start||0,Math.ceil(e.length/this.options.itemsPerPage)),a=Math.floor(e.start/this.options.itemsPerPage)+1,n=5<i?Math.min(Math.max(1,a-2),i-4):1,s=5<i?Math.max(Math.min(i,a+2),5):i,o=1;if(!(void 0===e.length||i<2))do{}while(t+=2==o&&2<n||o==i-1&&s<i-1?'<span class="cbb-label">...</span>':'<a href="#" class="cbb-btn'+(o==a?" default-btn":"")+'" data-action="pagination" data-start="'+(o-1)*this.options.itemsPerPage+'">'+o+"</a>",2==o&&o<n-1?o=n:o==s&&s<i-1?o=i-1:o++,o<=i);return t},_currentImageInfo:function(e){var t,i,a=this;this.getObj(".cbb-dialog-sidebar").html(""),u.index.length&&(i="icon"==(t=this.getActivePanel().items[u.index.slice(-1)[0]]).type?"details-icon":"attachment"==t.type&&a.options.allowImageInfo?"details-image-editable":"details-image",i=this._getTemplate(i,t),!1===e&&i.find('[data-action="update"]').remove(),this.getObj(".cbb-dialog-sidebar").append(i),i.find("[data-action]").click(function(e){a._dispatch(c(this),e)}))},_dispatch:function(e,t){t.preventDefault();let a;switch(e.attr("data-action")){case"copy":this._hasList()&&(c.each(u.index,function(e,t){t=h[h.active].items[t];h[h.listTarget].items.push(t),h[h.listTarget].sortKeys&&h[h.listTarget].sortKeys.push(h[h.listTarget].items.length-1)}),this.unselectAll());break;case"delete":this._send({action:"delete"});break;case"delete-soft":"list"==this.getActivePanel().id&&this.removeSelected();break;case"pagination":a={action:"pagination",section:h[h.active].id,query:h[h.active].query,start:e.attr("data-start")},h[h.active].start=a.start,this._send(a);break;case"search":var i=c.trim(this.getObj('[name="keywords"]').val());i&&(h[h.active].query=i,a={action:"search",section:h[h.active].id,query:h[h.active].query},this._send(a));break;case"submit":if("function"==typeof this.options.onSubmit||d.hasListener("core.media.submit")){let i=this.getActivePanel();switch(a=[],this.options.returnMask){case"list":if(this._hasList()&&c.each(h[h.listTarget].items,function(e,t){a.push(t)}),"list"==i.id)break;case"selected":"list"!=i.id&&c.each(u.index,function(e,t){a.push(i.items[t])});break;case"simple":u.index.length&&a.push(i.items[u.index.slice(-1)])}"list"!=this.options.returnMask&&!a.length||("function"==typeof this.options.onSubmit&&this.options.onSubmit.apply(c,[a]),d.dispatchEvent("core.media.submit",{data:a,instanceID:this.options.instanceID}))}this._modal.cbbDialog("close");break;case"update":this._updateSettings(),(a=this.getActivePanel().items[u.index.slice(-1)[0]]).action="update",this._send(a)}},_hasGallery:function(){return void 0!==h.uploadTarget&&"gallery"==h[h.uploadTarget].id},_hasList:function(){return void 0!==h.listTarget&&"list"==h[h.listTarget].id},_response:function(a){var n=this;switch(a.action){case"create":a.options&&c.extend(this.options,a.options),c(a.htmlContent).cbbDialog({customClass:"media-modal",autoClean:!1,destroyOnClose:!0,movable:!1,onOpen:function(){var e;n._modal=this,a.sections&&(h=a.sections,c.each(h,function(e,t){if("separator"==t)return n.getObj(".cbb-dialog-menu").append('<li class="row-separator"></li>'),!0;"gallery"==t.id?h.uploadTarget=e:"list"==t.id&&(h.listTarget=e,n.options.allowGallery||(h.uploadTarget=e)),h[e].launcher=n._getTemplate("menu-item",t).appendTo(n.getObj(".cbb-dialog-menu")).children("a").data("sectionId",e)}),this.find(".cbb-dialog-menu a").click(function(e){n.setActivePanel(c(this).data("sectionId"),!0),e.preventDefault()}),this.find("[data-action]").click(function(e){n._dispatch(c(this),e)}),e=h.listTarget||0,h[e].launcher.click(),n._updateSubmitStatus())},onClose:function(){n.reset()}});break;case"delete":if(n._hasList()&&n._hasGallery()){let i="gallery"==n.getActivePanel().id?h.listTarget:h.uploadTarget;void 0!==i&&a.items&&(c.each(h[i].items,function(e,t){t.originalId&&-1!=c.inArray(t.originalId,a.items)&&delete h[i].items[e]}),this.rebuildSection(i))}this.removeSelected();break;case"pagination":case"search":c.extend(h[h.active],a.section),this.setActivePanel(h.active);break;case"update":d.floatMessage(a.message,1e3,a.status);break;case"insert":n.setActivePanel(h.uploadTarget,!0,function(e){e||(h[h.uploadTarget].items=c.merge(c.merge([],[a.item]),h[h.uploadTarget].items),n.setActivePanel(h.uploadTarget)),n.setSelection([0])})}},_select:function(e,t,i){var a=d.intval(e.attr("data-id")),n=null,s=this;if(0==t)i&&e.is(".selected")&&!e.is(".active")?(u.index.length&&u.items[u.index.slice(-1)].removeClass("active"),u.index.splice(u.index.indexOf(a),1),u.index.push(a),e.addClass("active")):(e.removeClass("selected"),delete u.items[a],u.index.splice(u.index.indexOf(a),1),u.index.length?u.items[u.index.slice(-1)].addClass("active"):n=!1);else{if(void 0!==u.items[a])return!1;"list"!=this.options.returnMask&&!s.getActivePanel().editable||(n=!0),i&&(0==i.ctrlKey||!s.getActivePanel().editable&&-1==c.inArray(s.options.returnMask,["selected","list"]))&&s.unselectAll(),u.index.length&&u.items[u.index.slice(-1)].removeClass("active"),e.addClass("selected active"),u.items[a]=e,u.index.push(a)}this._currentImageInfo(),this._updateSubmitStatus();t=this.getObj(".media-toolbar-secondary");t.find(".value").text(u.index.length),null!==n&&(t.find('[data-action="delete"]').objView(n&&s.getActivePanel().editable),t.find('[data-action="delete-soft"]').objView("list"==this.getActivePanel().id&&this._hasGallery()&&n&&s.getActivePanel().editable),t.find('[data-action="copy"]').objView(this._hasList()&&"list"!=this.getActivePanel().id),t.objView(n))},_send:function(e,t,i){var n=this,e=(e.type=n.options.type,{url:this.options.baseUrl,data:{cbbModule:"media",mediaInstance:n.options.instanceID,media:e},onSuccess:function(e){n._response(e),"function"==typeof i&&i.call(n)},onDialogSubmit:function(e,i){var a=n.getActivePanel();i.media={items:[]},c.each(u.index,function(e,t){i.media.items.push(a.items[t].originalId)}),delete i.action}});return e.data=c.extend(!0,e.data,this.options.requestData,t),d.request(e)},_updateSettings:function(){var e={};this.getObj("[data-setting]").each(function(){e[c(this).attr("data-setting")]=c(this).val()}),c.extend(h[h.active].items[u.index.slice(-1)[0]],e)},_updateSubmitStatus:function(){var e=!1;"list"==this.options.returnMask||u.index.length||(e=!0),this.getObj('[data-action="submit"]').prop("disabled",e)},_getTemplate:function(e,t){return d.template.get(e,t,!0)},_handleUpload:function(e){var t={cbbModule:"media",mediaInstance:this.options.instanceID,media:{action:"upload"}},t=c.extend(!0,t,this.options.requestData);a.FileList=[],a.statusDom=this.getObj(".upload-inline-status"),Array.prototype.push.apply(a.FileList,("drop"==e.type?e.originalEvent.dataTransfer:e.target).files),this.getObj(".uploader-inline").objView(!1),a.statusDom.objView(!0),this._prepareFileForUpload(0,function(){this._uploadNextFile(t)})},_prepareFileForUpload:function(t,i){var e;null==a.FileList[t]?i.call(this):(e=a.FileList[t],this.options.imageMaxWidth&&this.options.imageMaxHeight&&e.type.match(/(image.(?:gif|jpg|jpeg|png|webp))/)?this._resizeImage(e,function(e){a.FileList[t]=e,a.totalBytes+=e.size,this._prepareFileForUpload(t+1,i)}):(a.totalBytes+=e.size,this._prepareFileForUpload(t+1,i)))},_uploadNextFile:function(t){var i=this;if(a.current++,null==a.FileList[a.current])return this.setActivePanel(h.uploadTarget,!0,function(e){var t=[];c.each(a.result,function(e){t.push(e)}),e||(h[h.uploadTarget].items=c.merge(c.merge([],a.result),h[h.uploadTarget].items),i.setActivePanel(h.uploadTarget)),i.setSelection(t),a.error.length&&d.floatMessage(a.error.join("<br />"),null,d.JSON_ERROR),i.resetQueue()}),!0;a.data=new FormData,c.each(t,function(i,e){"object"==typeof e?c.each(e,function(e,t){a.data.append(i+"["+e+"]",t)}):a.data.append(i,e)}),a.data.append("file",a.FileList[a.current],a.FileList[a.current].name);var e=c.extend(!0,{},c.ajaxSettings,{contentType:!1,processData:!1,cache:!1,type:"POST",dataType:"json",data:a.data,success:function(e){e.status==d.JSON_SUCCESS?a.result.push(e.item):a.error.push(e.message),i._uploadNextFile(t)},error:d.ajaxErrorCode});return e.xhr=function(){var e=c.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",function(e){var t=e.loaded||e.position;e.lengthComputable&&(a.bytesLoaded+=t,e=Math.ceil(a.bytesLoaded/a.totalBytes*100),a.statusDom.find('[role="progressbar"]').css("width",e+"%"))},!1),e},c.ajax(e)},_getBaseName:function(e){e=new String(e).substring(e.lastIndexOf("/")+1);return-1!=e.lastIndexOf(".")?e.substring(0,e.lastIndexOf(".")):e},_resizeImage:function(o,l){var r=this,e=new FileReader;e.onload=function(e){var s=new Image;s.onload=function(){var e=document.createElement("canvas"),t=r.options.imageMaxHeight,i=r.options.imageMaxWidth,a=s.width,n=s.height,i=(n<a?i<a&&(n*=i/a,a=i):t<n&&(a*=t/n,n=t),e.width=a,e.height=n,e.getContext("2d").drawImage(s,0,0,a,n),e.toDataURL(o.type)),t=r._dataURLToBlob(i);t.name=o.name,l.call(r,t)},s.src=e.target.result},e.readAsDataURL(o)},_dataURLToBlob:function(e){var t=";base64,";if(-1==e.indexOf(t))n=(i=e.split(","))[1];else for(var i=e.split(t),a=window.atob(i[1]),n=new Uint8Array(a.length),s=0;s<a.length;++s)n[s]=a.charCodeAt(s);return new Blob([n],{type:i[0].split(":")[1]})}})})(jQuery,cbbCore);